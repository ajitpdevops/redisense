{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="/devices">Devices</a></li>
                <li class="breadcrumb-item active">{{ device.name or device.device_id }}</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">
                {% if device.status.value == 'normal' %}
                    <i class="bi bi-circle-fill text-success"></i>
                {% elif device.status.value == 'maintenance' %}
                    <i class="bi bi-circle-fill text-warning"></i>
                {% else %}
                    <i class="bi bi-circle-fill text-danger"></i>
                {% endif %}
                {{ device.name or device.device_id }}
            </h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button type="button" class="btn btn-outline-info" onclick="findSimilarDevices()">
                    <i class="bi bi-search"></i> Find Similar
                </button>
                <a href="/devices" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Devices
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Device Information -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Device Information
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td class="text-muted">ID:</td>
                        <td><code>{{ device.device_id }}</code></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Type:</td>
                        <td><span class="badge bg-primary">{{ device.device_type.value }}</span></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Status:</td>
                        <td>
                            {% if device.status.value == 'normal' %}
                                <span class="badge bg-success">Normal</span>
                            {% elif device.status.value == 'maintenance' %}
                                <span class="badge bg-warning">Maintenance</span>
                            {% else %}
                                <span class="badge bg-danger">Anomaly</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Manufacturer:</td>
                        <td>{{ device.manufacturer or 'Unknown' }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Model:</td>
                        <td>{{ device.model or 'Unknown' }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Location:</td>
                        <td>
                            <i class="bi bi-geo-alt"></i> {{ device.location or 'Not specified' }}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Power Rating:</td>
                        <td>{{ device.power_rating or 'Unknown' }}{% if device.power_rating %} W{% endif %}</td>
                    </tr>
                </table>

                {% if device.description %}
                <div class="mt-3">
                    <small class="text-muted">Description:</small>
                    <p class="mb-0">{{ device.description }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <!-- Recommended Devices Section -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-stars"></i> Recommended Similar Devices
                </h5>
                <div>
                    <button type="button" class="btn btn-outline-success btn-sm me-2" onclick="loadRecommendedDevices()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="findSimilarDevices()">
                        <i class="bi bi-search"></i> Find More
                    </button>
                </div>
            </div>
            <div class="card-body" id="recommendedDevicesContainer">
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="ms-2 text-muted">Loading recommendations...</span>
                </div>
            </div>
        </div>

        <!-- Current Metrics Section -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-activity"></i> Current Metrics
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="display-6 text-warning mb-2">
                            <i class="bi bi-lightning-fill"></i>
                        </div>
                        <h4 class="text-warning">{{ "%.2f"|format(metrics.current_power) }}</h4>
                        <p class="text-muted mb-0">Current Power (kW)</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="display-6 text-info mb-2">
                            <i class="bi bi-bar-chart-fill"></i>
                        </div>
                        <h4 class="text-info">{{ "%.2f"|format(metrics.avg_power) }}</h4>
                        <p class="text-muted mb-0">Average Power (kW)</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="display-6 text-success mb-2">
                            <i class="bi bi-graph-up-arrow"></i>
                        </div>
                        <h4 class="text-success">{{ "%.2f"|format(metrics.max_power) }}</h4>
                        <p class="text-muted mb-0">Peak Power (kW)</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="display-6 text-primary mb-2">
                            <i class="bi bi-battery-charging"></i>
                        </div>
                        <h4 class="text-primary">{{ "%.2f"|format(metrics.total_energy) }}</h4>
                        <p class="text-muted mb-0">Total Energy (kWh)</p>
                    </div>
                </div>

                <hr class="my-4">

                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Connection Status:</span>
                            <span class="badge bg-{{ 'success' if metrics.status == 'online' else 'danger' if metrics.status == 'offline' else 'warning' }}">
                                {{ metrics.status|title }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Total Readings:</span>
                            <span class="fw-bold">{{ metrics.reading_count }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> Power Consumption Trends
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="updateChart(1)">1H</button>
                    <button type="button" class="btn btn-outline-primary" onclick="updateChart(6)">6H</button>
                    <button type="button" class="btn btn-outline-primary" onclick="updateChart(24)">24H</button>
                    <button type="button" class="btn btn-outline-primary" onclick="updateChart(168)">7D</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="powerChart" width="400" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analytics -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart"></i> Energy Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="energyDistributionChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history"></i> Usage Patterns
                </h5>
            </div>
            <div class="card-body">
                <canvas id="usagePatternChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Readings -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-table"></i> Recent Readings
                </h5>
                <button class="btn btn-outline-primary btn-sm" onclick="exportData()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
            <div class="card-body">
                {% if readings %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Energy (kWh)</th>
                                <th>Power (kW)</th>
                                <th>Voltage (V)</th>
                                <th>Current (A)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reading in readings[-10:] %}
                            <tr>
                                <td>{{ reading.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>{{ "%.3f"|format(reading.energy_kwh) }}</td>
                                <td>{{ "%.3f"|format(reading.power_kw or reading.energy_kwh) }}</td>
                                <td>{{ "%.1f"|format(reading.voltage) if reading.voltage else 'N/A' }}</td>
                                <td>{{ "%.2f"|format(reading.current) if reading.current else 'N/A' }}</td>
                                <td>
                                    <span class="badge bg-success">Normal</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <div class="text-muted">
                        <i class="bi bi-table display-4"></i>
                        <h5 class="mt-3">No readings available</h5>
                        <p>Start streaming data to see device readings.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Similar Devices Modal -->
<div class="modal fade" id="similarDevicesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Devices Similar to {{ device.name or device.device_id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="similarDevicesContent">
                <!-- Content loaded via JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let powerChart;
let energyDistributionChart;
let usagePatternChart;

function initializeCharts() {
    // Power consumption chart
    const powerCtx = document.getElementById('powerChart').getContext('2d');
    powerChart = new Chart(powerCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Power (kW)',
                data: [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            interaction: {
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Energy distribution chart
    const energyCtx = document.getElementById('energyDistributionChart').getContext('2d');
    energyDistributionChart = new Chart(energyCtx, {
        type: 'doughnut',
        data: {
            labels: ['Peak Hours', 'Normal Hours', 'Off-Peak Hours'],
            datasets: [{
                data: [30, 50, 20],
                backgroundColor: ['#dc3545', '#0d6efd', '#198754']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Usage pattern chart
    const usageCtx = document.getElementById('usagePatternChart').getContext('2d');
    usagePatternChart = new Chart(usageCtx, {
        type: 'bar',
        data: {
            labels: ['00:00', '06:00', '12:00', '18:00'],
            datasets: [{
                label: 'Average Power (kW)',
                data: [1.2, 2.1, 3.5, 2.8],
                backgroundColor: '#20c997'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Load initial data
    updateChart(1);
}

function updateChart(hours) {
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    // Fetch data
    fetch(`/api/device/{{ device.device_id }}/readings?hours=${hours}`)
        .then(response => response.json())
        .then(data => {
            const labels = data.map(reading => new Date(reading.timestamp).toLocaleTimeString());
            const powerData = data.map(reading => reading.power_kw);

            powerChart.data.labels = labels;
            powerChart.data.datasets[0].data = powerData;
            powerChart.update();
        })
        .catch(error => {
            console.error('Error updating chart:', error);
        });
}

function refreshData() {
    location.reload();
}

function findSimilarDevices() {
    const modal = new bootstrap.Modal(document.getElementById('similarDevicesModal'));
    const content = document.getElementById('similarDevicesContent');
    const deviceId = '{{ device.device_id }}';

    content.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">Finding similar devices...</p></div>';
    modal.show();

    const apiUrl = `/api/devices/similar/${deviceId}?limit=5`;
    console.log('Modal: Fetching from URL:', apiUrl);

    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Handle error response from API
            if (data.error) {
                content.innerHTML = `<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> ${data.error}</div>`;
                return;
            }

            // Ensure data is an array
            if (!Array.isArray(data)) {
                content.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Invalid response format from server.</div>';
                return;
            }

            if (data.length === 0) {
                content.innerHTML = '<div class="text-center text-muted"><i class="bi bi-search"></i><p class="mt-2">No similar devices found.</p></div>';
                return;
            }

            let html = '<div class="row">';
            data.forEach(item => {
                const device = item.device;
                const score = (item.score * 100).toFixed(1);
                const deviceName = device.name || device.device_id;
                const deviceType = device.device_type?.value || device.device_type || 'Unknown';
                const manufacturer = device.manufacturer || 'Unknown';
                const location = device.location || 'Unknown';

                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title">${deviceName}</h6>
                                <p class="text-muted small mb-2">${deviceType} â€¢ ${manufacturer}</p>
                                <p class="text-muted small mb-2"><i class="bi bi-geo-alt"></i> ${location}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-success">${score}% Match</span>
                                    <a href="/device/${device.device_id}" class="btn btn-sm btn-outline-primary">View Details</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            content.innerHTML = html;
        })
        .catch(error => {
            console.error('Error finding similar devices:', error);
            content.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Error loading similar devices: ${error.message}</div>`;
        });
}

function exportData() {
    alert('Data export functionality would be implemented here. This would generate a CSV/Excel file with device readings.');
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing page...');

    try {
        console.log('Initializing charts...');
        initializeCharts();
        console.log('Charts initialized successfully');
    } catch (chartError) {
        console.error('Error initializing charts:', chartError);
    }

    // Add a delay to ensure the page is fully rendered
    setTimeout(() => {
        try {
            console.log('Loading recommended devices after delay...');
            loadRecommendedDevices();
        } catch (loadError) {
            console.error('Error loading recommended devices:', loadError);
        }
    }, 1000); // 1 second delay
});

function loadRecommendedDevices() {
    console.log('loadRecommendedDevices() called');

    const container = document.getElementById('recommendedDevicesContainer');
    if (!container) {
        console.error('recommendedDevicesContainer not found in DOM');
        return;
    }

    console.log('Container found:', container);

    const deviceId = '{{ device.device_id }}';

    console.log('Loading recommended devices for device:', deviceId);

    if (!deviceId || deviceId === '') {
        console.error('Device ID is empty');
        container.innerHTML = '<div class="alert alert-danger alert-sm"><i class="bi bi-x-circle"></i> Device ID not found.</div>';
        return;
    }

    // Show loading state
    container.innerHTML = `<div class="text-center py-3">
        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        <span class="ms-2 text-muted">Loading recommendations...</span>
    </div>`;

    // Set a timeout to prevent infinite spinning
    const timeoutId = setTimeout(() => {
        console.log('Recommendation loading timed out');
        container.innerHTML = `<div class="alert alert-warning alert-sm"><i class="bi bi-clock"></i> Recommendation loading timed out. <button class="btn btn-link btn-sm p-0" onclick="loadRecommendedDevices()">Try again</button></div>`;
    }, 10000); // 10 second timeout

    const apiUrl = `/api/devices/similar/${deviceId}?limit=3`;
    console.log('Fetching from URL:', apiUrl);

    fetch(apiUrl)
        .then(response => {
            clearTimeout(timeoutId);
            console.log('Response status:', response.status);
            console.log('Response URL:', response.url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            console.log('Data type:', typeof data);
            console.log('Is array:', Array.isArray(data));

            // Handle error response from API
            if (data && data.error) {
                console.log('API returned error:', data.error);
                container.innerHTML = `<div class="alert alert-warning alert-sm"><i class="bi bi-exclamation-triangle"></i> ${data.error}</div>`;
                return;
            }

            // Ensure data is an array
            if (!Array.isArray(data)) {
                console.log('Data is not an array:', typeof data, data);
                container.innerHTML = '<div class="alert alert-info alert-sm"><i class="bi bi-info-circle"></i> No recommendations available at this time.</div>';
                return;
            }

            console.log('Number of recommendations:', data.length);

            if (data.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-search"></i><p class="mt-2 mb-0">No similar devices found.</p></div>';
                return;
            }

            // Process and display the recommendations
            let html = '<div class="row">';
            let successCount = 0;

            data.forEach((item, index) => {
                try {
                    console.log(`Processing item ${index}:`, item);

                    const device = item.device || {};
                    const score = Math.round((item.score || 0) * 100);
                    const deviceName = device.name || device.device_id || 'Unknown Device';
                    const deviceType = device.device_type || 'Unknown';
                    const location = device.location || 'Unknown';

                    console.log(`Item ${index} - Name: ${deviceName}, Type: ${deviceType}, Score: ${score}%`);

                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card border-0 bg-light h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0 text-truncate">${deviceName}</h6>
                                        <span class="badge bg-success ms-2">${score}%</span>
                                    </div>
                                    <p class="text-muted small mb-1">${deviceType}</p>
                                    <p class="text-muted small mb-2"><i class="bi bi-geo-alt"></i> ${location}</p>
                                    <a href="/device/${device.device_id}" class="btn btn-outline-primary btn-sm w-100">
                                        <i class="bi bi-eye"></i> View Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    successCount++;
                } catch (itemError) {
                    console.error('Error processing recommendation item:', itemError, item);
                }
            });
            html += '</div>';

            console.log(`Successfully processed ${successCount} out of ${data.length} recommendations`);
            container.innerHTML = html;
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Error loading recommended devices:', error);

            // For debugging, let's show a test recommendation
            const testData = [
                {
                    device: {
                        device_id: 'test-device',
                        name: 'Test Device',
                        device_type: 'Test Type',
                        location: 'Test Location'
                    },
                    score: 0.85
                }
            ];

            console.log('Showing test data due to error:', testData);

            // Try to render the test data to verify the template logic works
            let html = '<div class="row">';
            testData.forEach(item => {
                try {
                    const device = item.device || {};
                    const score = (item.score * 100).toFixed(0);
                    const deviceName = device.name || device.device_id || 'Unknown Device';
                    const deviceType = device.device_type || 'Unknown';
                    const location = device.location || 'Unknown';

                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card border-0 bg-light h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0 text-truncate">${deviceName}</h6>
                                        <span class="badge bg-success ms-2">${score}%</span>
                                    </div>
                                    <p class="text-muted small mb-1">${deviceType}</p>
                                    <p class="text-muted small mb-2"><i class="bi bi-geo-alt"></i> ${location}</p>
                                    <a href="/device/${device.device_id}" class="btn btn-outline-primary btn-sm w-100">
                                        <i class="bi bi-eye"></i> View Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (itemError) {
                    console.error('Error processing test recommendation item:', itemError, item);
                }
            });
            html += '</div>';
            html += `<div class="alert alert-info alert-sm mt-2">
                <i class="bi bi-info-circle"></i>
                API Error: ${error.message}. Showing test data to verify template.
                <button class="btn btn-link btn-sm p-0 ms-2" onclick="loadRecommendedDevices()">Try again</button>
            </div>`;

            container.innerHTML = html;
        });
}
</script>
{% endblock %}

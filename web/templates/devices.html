{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">
                <i class="bi bi-cpu-fill text-primary"></i>
                Device Management
            </h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-success" onclick="refreshDevices()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                    <i class="bi bi-plus-circle"></i> Add Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Device Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h5 class="text-success">{{ devices|selectattr("status.value", "equalto", "normal")|list|length }}</h5>
                <p class="text-muted mb-0">Normal</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h5 class="text-warning">{{ devices|selectattr("status.value", "equalto", "maintenance")|list|length }}</h5>
                <p class="text-muted mb-0">Maintenance</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h5 class="text-danger">{{ devices|selectattr("status.value", "equalto", "anomaly")|list|length }}</h5>
                <p class="text-muted mb-0">Anomaly</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h5 class="text-primary">{{ devices|length }}</h5>
                <p class="text-muted mb-0">Total Devices</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="statusFilter" class="form-label">Filter by Status</label>
                        <select class="form-select" id="statusFilter" onchange="filterDevices()">
                            <option value="">All Status</option>
                            <option value="normal">Normal</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="anomaly">Anomaly</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="typeFilter" class="form-label">Filter by Type</label>
                        <select class="form-select" id="typeFilter" onchange="filterDevices()">
                            <option value="">All Types</option>
                            {% for device_type in devices|map(attribute='device_type.value')|unique %}
                            <option value="{{ device_type }}">{{ device_type|title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="searchInput" class="form-label">Search Devices</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by name or ID..." onkeyup="filterDevices()">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Grid -->
<div class="row" id="deviceGrid">
    {% for device in devices %}
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4 device-item"
         data-status="{{ device.status.value }}"
         data-type="{{ device.device_type.value }}"
         data-name="{{ device.name or device.device_id }}"
         data-id="{{ device.device_id }}">
        <div class="card device-card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        {% if device.status.value == 'normal' %}
                            <i class="bi bi-circle-fill text-success"></i>
                        {% elif device.status.value == 'maintenance' %}
                            <i class="bi bi-circle-fill text-warning"></i>
                        {% else %}
                            <i class="bi bi-circle-fill text-danger"></i>
                        {% endif %}
                        {{ device.name or device.device_id }}
                    </h6>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/device/{{ device.device_id }}">
                                <i class="bi bi-eye"></i> View Details
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="findSimilar('{{ device.device_id }}')">
                                <i class="bi bi-search"></i> Find Similar
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteDevice('{{ device.device_id }}')">
                                <i class="bi bi-trash"></i> Delete
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <span class="badge bg-primary">{{ device.device_type.value }}</span>
                        <span class="badge bg-secondary ms-1">{{ device.manufacturer or 'Unknown' }}</span>
                    </div>
                </div>

                <div class="mb-3">
                    <small class="text-muted"><i class="bi bi-geo-alt"></i> Location</small>
                    <div>{{ device.location or 'Not specified' }}</div>
                </div>

                <div class="mb-3">
                    <small class="text-muted"><i class="bi bi-lightning"></i> Power Rating</small>
                    <div>{{ device.power_rating or 'Unknown' }}{% if device.power_rating %} W{% endif %}</div>
                </div>

                {% if device.device_id in latest_readings %}
                {% set reading = latest_readings[device.device_id] %}
                <div class="mb-3">
                    <small class="text-muted"><i class="bi bi-activity"></i> Current Power</small>
                    <div class="fw-bold text-warning">{{ "%.2f"|format(reading.power_kw or reading.energy_kwh) }} kW</div>
                </div>

                <div class="mb-3">
                    <small class="text-muted"><i class="bi bi-clock"></i> Last Reading</small>
                    <div>{{ reading.timestamp.strftime('%H:%M:%S') }}</div>
                </div>
                {% else %}
                <div class="mb-3">
                    <small class="text-muted"><i class="bi bi-exclamation-triangle"></i> Status</small>
                    <div class="text-danger">No recent data</div>
                </div>
                {% endif %}
            </div>

            <div class="card-footer bg-white border-0">
                <div class="d-grid gap-2 d-md-flex">
                    <a href="/device/{{ device.device_id }}" class="btn btn-primary btn-sm flex-fill">
                        <i class="bi bi-eye"></i> Details
                    </a>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="showDeviceChart('{{ device.device_id }}')">
                        <i class="bi bi-graph-up"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Empty State -->
<div id="emptyState" class="text-center py-5" style="display: none;">
    <div class="text-muted">
        <i class="bi bi-search display-4"></i>
        <h5 class="mt-3">No devices found</h5>
        <p>Try adjusting your filters or search terms.</p>
    </div>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">In the current implementation, devices are managed through the CLI. Use the following command to add devices:</p>
                <code>uv run python cli.py seed-data --device-count 1</code>
                <p class="text-muted mt-3">For production use, this would be a full device registration form.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Similar Devices Modal -->
<div class="modal fade" id="similarDevicesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Similar Devices</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="similarDevicesContent">
                <!-- Content loaded via JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshDevices() {
    location.reload();
}

function filterDevices() {
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const searchInput = document.getElementById('searchInput').value.toLowerCase();

    const deviceItems = document.querySelectorAll('.device-item');
    let visibleCount = 0;

    deviceItems.forEach(item => {
        const status = item.dataset.status;
        const type = item.dataset.type;
        const name = item.dataset.name.toLowerCase();
        const id = item.dataset.id.toLowerCase();

        const statusMatch = !statusFilter || status === statusFilter;
        const typeMatch = !typeFilter || type === typeFilter;
        const searchMatch = !searchInput || name.includes(searchInput) || id.includes(searchInput);

        if (statusMatch && typeMatch && searchMatch) {
            item.style.display = 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });

    // Show empty state if no devices visible
    document.getElementById('emptyState').style.display = visibleCount === 0 ? 'block' : 'none';
}

function findSimilar(deviceId) {
    const modal = new bootstrap.Modal(document.getElementById('similarDevicesModal'));
    const content = document.getElementById('similarDevicesContent');

    content.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">Finding similar devices...</p></div>';
    modal.show();

    fetch(`/api/devices/similar/${deviceId}?limit=5`)
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) {
                content.innerHTML = '<div class="text-center text-muted"><i class="bi bi-search"></i><p class="mt-2">No similar devices found.</p></div>';
                return;
            }

            let html = '<div class="row">';
            data.forEach(item => {
                const device = item.device;
                const score = (item.score * 100).toFixed(1);

                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title">${device.name || device.device_id}</h6>
                                <p class="text-muted small mb-2">${device.device_type.value} • ${device.manufacturer || 'Unknown'}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-success">${score}% Match</span>
                                    <a href="/device/${device.device_id}" class="btn btn-sm btn-outline-primary">View</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            content.innerHTML = html;
        })
        .catch(error => {
            content.innerHTML = '<div class="alert alert-danger">Error loading similar devices: ' + error.message + '</div>';
        });
}

function deleteDevice(deviceId) {
    if (confirm('Are you sure you want to delete this device? This action cannot be undone.')) {
        // In a real implementation, this would make a DELETE request
        alert('Device deletion would be implemented here. Currently, use CLI commands to manage devices.');
    }
}

function showDeviceChart(deviceId) {
    // Open device detail page in new tab for quick chart view
    window.open(`/device/${deviceId}`, '_blank');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to device cards
    document.querySelectorAll('.device-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>
{% endblock %}
